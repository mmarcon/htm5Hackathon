<!doctype html>
<html>
	<head>
		<meta charset="utf-8">
		<title>Nokia Maps Mashup</title>
		<style>
		html,body, #mapContainer {
			font-family: sans-serif;
			background: #fff;
			color: #444;
			height: 100%;
			padding:0;
			margin:0;
		}

		.listener {
			width: 50px;
			height: 50px;
			position: absolute;
			top: 50%;
			left: 50%;
			margin: -25px 0 0 -25px;
		}

		</style>
		<script src="http://api.maps.nokia.com/2.2.0/jsl.js"></script>
		<script src="http://ajax.googleapis.com/ajax/libs/jquery/1.7/jquery.min.js"></script>
		<link rel="icon" href="http://maps.nokia.com/favicon.ico">
	</head>
	<body>
		<div id="mapContainer"></div>
		<img class="listener" src="arrow.png"></img>
		<script src="API.js"></script>
		<script src="audio.js"></script>
		<script src="keyboard.js"></script>
		<script src="freesound-data.js"></script>
		<script>
		(function() {
			var APP = window.APP || {},
		    init = function() {
		    	APP.ListenerObj = new APP.Listener();
		    	APP.ListenerObj.bindKeyboardEvents();
		    	APP.freesound = new APP.API.Freesound();
		    	APP.freesound.aSounds = [];
				
		        // Authentication set-up is the first thing that you must do with the API 
		        nokia.maps.util.ApplicationContext.set({
		            "appId": "YOUR_APP_ID",
		            "authenticationToken": "YOUR_AUTHENTICATION_TOKEN"
		        });

        		navigator.geolocation.getCurrentPosition(createMap, createMap);


		        // createMap();
		        // ensureSize();

				// This makes sure the map is always the right size
		        // $(window).resize(ensureSize);
		    },

		    createMap = function(position) {
		    	position.coords = position.coords || {"latitude": 52.51, "longitude": 13.4};
		    	var infoBubbles = new nokia.maps.map.component.InfoBubbles(),
		        	mapContainer = document.getElementById("mapContainer"),
		        	map = new nokia.maps.map.Display(mapContainer, {
		            center: [position.coords.latitude, position.coords.longitude],
		            zoomLevel: 14,
		            components: [
		                new nokia.maps.map.component.ZoomBar(),
		                new nokia.maps.map.component.Behavior(),
		                new nokia.maps.map.component.TypeSelector(),
		                new nokia.maps.map.component.Traffic(),
		                new nokia.maps.map.component.PublicTransport(),
		                new nokia.maps.map.component.Overview(),
		                new nokia.maps.map.component.ScaleBar(),
		                new nokia.maps.positioning.component.Positioning(),
		                infoBubbles
		                ]
		        });
			    APP.ListenerObj.setLatLng(position.coords.latitude, position.coords.longitude);
			    APP.map = map;
			    APP.infoBubbles = infoBubbles;
			    Audio.setListenerPosition(APP.ListenerObj.getPosition());
			    var vp = APP.map.getViewBounds();
			    APP.freesound.retrieveSoundsFor({minLat: vp.bottomRight.latitude,
			    	                             minLng: vp.topLeft.longitude,
			    	                             maxLat: vp.topLeft.latitude,
			    	                             maxLng: vp.bottomRight.longitude},
			    	                             addSound);
		    },

		    ensureSize = function() {
		        // $('#mapContainer').height($('body').height() - $('#header').height());
		    },

		    addSound = function(sound) {
		    	var soundObj = Audio.createSource();
		    	Audio.setAudioSource(soundObj, sound['preview-hq-mp3']);
		    	soundObj.panner.setPosition(sound.geotag.lon, sound.geotag.lat, 0);
		    	var marker = new nokia.maps.map.StandardMarker({latitude: sound.geotag.lat, longitude: sound.geotag.lon});
		        marker.text = sound.tags.join(', ');
		        marker.coord = {latitude: sound.geotag.lat, longitude: sound.geotag.lon};

		        marker.addListener("click", function (evt) {
				    APP.infoBubbles.addBubble(this.text, this.coord);
				    evt.preventDefault();
				    evt.stopPropagation();
				});
		        APP.map.objects.add(marker);
		        soundObj.source.noteOn(Audio.getCurrentTime() + 0.020);
				APP.freesound.aSounds.push(soundObj);
		    };

		    var L;

		    APP.Listener = function(initialPos){
		    	this.domObj = $('.listener')[0];
		    	this.pos = initialPos || {lat: null, lng: null, orientation: 0};
		    };

		    L = APP.Listener.prototype;

		    L.setLatLng = function(lat, lng) {
		    	this.pos.lat = lat;
		    	this.pos.lng = lng;
				this.updateAudioPosition();
		    };

		    L.setOrientation = function(orientation) {
		    	this.pos.orientation = orientation;
		    	this.domObj.style[this.vendorPrefixed("transform")] = "rotate("+this.pos.orientation+"rad)";
				this.updateAudioPosition();
		    };
			
			L.updateAudioPosition = function() {
		        Audio.setListenerPosition({lat:this.pos.lat,lng:this.pos.lng,orientation:this.pos.orientation});
			}

		    L.getPosition = function() {
		    	return this.pos;
		    };

		    L.getOrientation = function() {
		    	return this.pos.orientation;
		    };

		    L.vendorPrefixed = function(s){return eval(0+"O-Moz-Webkit-Ms-".replace(/.*?-|$/g,"||(s='$&"+s+"')in new Image().style&&s").replace(/-(.)/g,"'+'$1'.toUpperCase()+'"))};

		    L.bindKeyboardEvents = function() {
		    	var self = this;
				KeyboardController({
				    37: function() { 
						self.setOrientation(self.getOrientation()-0.1);
					},
				    38: function() { 
	    				var newX = Math.sin(self.getOrientation()) * 10,
	    					newY = Math.cos(self.getOrientation()) * -10;
	    				APP.map.pan(0, 0, newX, newY, 'default');
	    				self.setLatLng(APP.map.center.latitude, APP.map.center.longitude);
					},
				    39: function() { 
						self.setOrientation(self.getOrientation()+0.1);
					},
				    40: function() { 
						var newX = Math.sin(self.getOrientation()) * -10,
	    					newY = Math.cos(self.getOrientation()) * 10;
	    				APP.map.pan(0, 0, newX, newY, 'default');
	    				self.setLatLng(APP.map.center.latitude, APP.map.center.longitude);
					}
				}, 20);
		    };

		    var setUpTestData = function() {
		        Audio.setListenerPosition({lat:52.5233,lng:13.4127,orientation:0});
		    	fsAudio = [];

	    		for (var i = 0; i < Math.min(5, fs.sounds.length); i++) {
			        fsAudio[i] = Audio.createSource();
			        Audio.setAudioSource(fsAudio[i], fs.sounds[i]['preview-hq-mp3']);
			        fsAudio[i].panner.setPosition(fs.sounds[i]['geotag'].lon, fs.sounds[i]['geotag'].lat,0);
			        var marker = new nokia.maps.map.StandardMarker({latitude: fs.sounds[i]['geotag'].lat, longitude: fs.sounds[i]['geotag'].lon});
			        marker.text = fs.sounds[i]['tags'].join(', ');
			        marker.coord = {latitude: fs.sounds[i]['geotag'].lat, longitude: fs.sounds[i]['geotag'].lon};

			        marker.addListener("click", function (evt) {
					    APP.infoBubbles.addBubble(this.text, this.coord);
					    evt.preventDefault();
					    evt.stopPropagation();
					});
			        APP.map.objects.add(marker);


			        fsAudio[i].source.noteOn(Audio.getCurrentTime() + 0.020);
			    }
		    };

		    $(function() {
		        init();
		    });
		})();
		</script>
	</body>
</html>
